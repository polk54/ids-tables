<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDS Country Table (Static JSON, Source 6 + WLD)</title>
  <meta name="description" content="International Debt Statistics (World Bank, source=6) â€” static JSON build (via GitHub Actions + Python) using 4D API with counterpart-area=WLD. Frontend loads from /data/*.json (same-origin)." />
  <style>
    :root{ --bg:#f7fafc; --card:#ffffff; --ink:#0b1220; --muted:#5b667a; --accent:#1b6ef3; --accent2:#0bb07b; --border:#e3e8ef; --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; --sans:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans)}
    header{position:sticky;top:0;z-index:5;background:#ffffffcc;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 20px}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:14px 0 6px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    select,button{background:var(--card);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    select{min-width:280px}
    button{cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{font-size:11px;color:var(--ink);background:#eef4ff;border:1px solid #d9e2ff;border-radius:999px;padding:6px 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .note{font-size:12px;color:var(--muted);padding:10px 12px;border-top:1px dashed var(--border)}
    .table-wrap{margin:14px 0 24px;overflow:auto;border-radius:14px;border:1px solid var(--border)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
    thead th{position:sticky;top:0;z-index:2;background:#f3f6fb;color:#3b465a;font-weight:600;text-align:right;padding:12px 10px;border-bottom:1px solid var(--border)}
    thead th:first-child{text-align:left}
    tbody td,tbody th{padding:10px;border-bottom:1px solid var(--border);text-align:right;white-space:nowrap}
    tbody th{text-align:left;font-weight:500}
    tbody tr:nth-child(2n) td,tbody tr:nth-child(2n) th{background:#f9fbfe}
    tbody tr:hover td,tbody tr:hover th{background:#eef4ff}
    .group-row th{background:#eef4ff;color:var(--accent);font-weight:700;border-top:1px solid var(--border);position:sticky;left:0;z-index:1}
    .sticky-first{position:sticky;left:0;background:inherit;z-index:1;max-width:420px;min-width:260px}
    .badge{font-size:10px;color:#3b465a;border:1px solid var(--border);border-radius:6px;padding:2px 6px;margin-left:6px}
    .mono{font-family:var(--mono);font-size:12px;color:var(--muted)}
    .footer{color:var(--muted);font-size:12px;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .footer a{color:var(--accent);text-decoration:none}
    .err{color:#a82b2b;font-size:13px;background:#fff2f2;border:1px solid #ffdede;padding:10px 12px;border-radius:10px}
    details.diag{margin:18px 0}
    details.diag summary{cursor:pointer;color:var(--accent)}
    pre.code{background:#f6f8fb;padding:10px 12px;border:1px solid var(--border);border-radius:10px;overflow:auto}
    .pass{color:#0f8a1a}
    .fail{color:#a82b2b}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>International Debt Statistics â€” Country Table</h1>
    <div class="sub">Static build (GitHub Actions + Python) from World Bank Data API (v2, <span class="mono">source=6</span>) using 4D with <span class="mono">counterpart-area=WLD</span>. The page reads same-origin JSON from <span class="mono">/data</span>.</div>
    <div class="toolbar">
      <div class="controls">
        <label for="countrySelect">Country</label>
        <select id="countrySelect" aria-label="Select a country"></select>
        <span id="status" class="pill" aria-live="polite">Loading local dataâ€¦</span>
      </div>
      <button id="downloadCsvBtn" disabled>Download CSV</button>
      <button id="copyCsvBtn" disabled>Copy CSV</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="alert" role="status" style="margin-top:10px"></div>
  <div class="table-wrap card">
    <table id="idsTable" aria-describedby="tableNote">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="note" id="tableNote">$ millions unless noted. Missing values shown as â€”. Source: World Bank, <em>International Debt Statistics</em> (IDS), API <span class="mono">source=6</span> (counterpart-area=WLD), materialized to static JSON by GitHub Actions.</div>
  </div>

  <details class="diag">
    <summary>Diagnostics & Tests</summary>
    <div style="margin:10px 0 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="btnPing">Check local JSON</button>
      <button id="btnRunTests">Run unit tests</button>
      <span id="testStatus" class="pill">Idle</span>
    </div>
    <div class="mono" id="diagOut"></div>
    <pre class="code" id="lastReq" aria-live="polite"></pre>
    <pre class="code" id="recentReqs"></pre>
  </details>

  <div class="footer">
    <div>ðŸ“˜ License: <a target="_blank" rel="noreferrer noopener" href="https://datacatalog.worldbank.org/public-licenses#cc-by">World Bank Open Data (CC BY 4.0)</a></div>
    <div>ðŸ”§ Built nightly by GitHub Actions</div>
  </div>
</main>

<script>
const YEARS_TO_SHOW = 11; // per your preference
const DATA_BASE = './data'; // must exist on GitHub Pages: /data/countries.json and /data/{ISO3}.json

// Indicators (mirrors our Python builder). All values are Source-6 4D with counterpart-area=WLD.
const INDICATOR_GROUPS = [
  { title: '1. Summary external debt data', rows: [
    { code: 'DT.DOD.DECT.CD', name: 'External debt stocks, total (DOD, current US$)', unit: 'USD_M' },
    { code: 'DT.DOD.DLXF.CD', name: 'Long-term external debt (DOD, current US$)', unit: 'USD_M' },
    { code: 'DT.DOD.DPPG.CD', name: 'Public and publicly guaranteed (DOD, current US$)', unit: 'USD_M' },
    { code: 'DT.DOD.DPNG.CD', name: 'Private nonguaranteed (DOD, current US$)', unit: 'USD_M' },
    { code: 'DT.DOD.DIMF.CD', name: 'Use of IMF credit and SDR allocations (DOD, current US$)', unit: 'USD_M' },
    { code: 'DT.DOD.DSTC.CD', name: 'Short-term external debt (DOD, current US$)', unit: 'USD_M' },
  ]},
  { title: '2. Debt service & flows', rows: [
    { code: 'DT.TDS.DECT.CD', name: 'Debt service on external debt, total (TDS, current US$)', unit: 'USD_M' },
    { code: 'DT.AMT.DECT.CD', name: 'Principal repayments on external debt, total (AMT, current US$)', unit: 'USD_M' },
    { code: 'DT.INT.DECT.CD', name: 'Interest payments on external debt, total (INT, current US$)', unit: 'USD_M' },
    { code: 'DT.DIS.DLXF.CD', name: 'Disbursements on external debt, long-term (DIS, current US$)', unit: 'USD_M' },
  ]},
  { title: '3. Ratios', rows: [
    { code: 'DT.DOD.DECT.GN.ZS', name: 'External debt stocks (% of GNI)', unit: 'PCT1' },
    { code: 'DT.TDS.DECT.EX.ZS', name: 'Total debt service (% of exports of goods, services and primary income)', unit: 'PCT1' },
    { code: 'DT.INT.DECT.EX.ZS', name: 'Interest payments on external debt (% of exports of goods, services and primary income)', unit: 'PCT1' },
  ]},
];

// --- Utilities & diagnostics ---
const els = {
  select: document.getElementById('countrySelect'),
  thead: document.getElementById('thead'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  alert: document.getElementById('alert'),
  copyCsvBtn: document.getElementById('copyCsvBtn'),
  downloadCsvBtn: document.getElementById('downloadCsvBtn'),
  btnPing: document.getElementById('btnPing'),
  btnRunTests: document.getElementById('btnRunTests'),
  testStatus: document.getElementById('testStatus'),
  diagOut: document.getElementById('diagOut'),
  lastReq: document.getElementById('lastReq'),
  recentReqs: document.getElementById('recentReqs'),
};

const recent = [];
function logReq(url){ recent.push(url); if(recent.length>12) recent.shift(); els.recentReqs.textContent = recent.map(u=>`GET ${u}`).join('\n'); els.lastReq.textContent = JSON.stringify({ url }, null, 2); }
function setStatus(t){ if(!t){ els.status.hidden=true; } else { els.status.hidden=false; els.status.textContent=t; } }
function showError(msg){ els.alert.innerHTML = `<div class="err">${msg}</div>`; }
function clearError(){ els.alert.textContent=''; }

async function getLocalJson(path){
  const url = `${DATA_BASE}/${path}`; logReq(url);
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
  return res.json();
}

// --- Country list from static JSON ---
async function loadCountries(){
  setStatus('Loading local dataâ€¦');
  let rows = [];
  try{ rows = await getLocalJson('countries.json'); }catch(e){ showError('countries.json not found in /data. Run the GitHub Action to build data.'); throw e; }
  if(!Array.isArray(rows) || !rows.length) { showError('countries.json is empty.'); throw new Error('Empty countries.json'); }
  rows.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  els.select.innerHTML = rows.map(c=>`<option value="${c.id}">${c.name} (${c.id})</option>`).join('');
  setStatus('');
  const def = new URLSearchParams(location.search).get('country') || rows.find(c=>c.id==='AFG')?.id || rows[0]?.id;
  if(def) els.select.value = def;
}

function numberFmt(v, unit){ if(v==null||Number.isNaN(v)) return 'â€”'; if(unit==='USD_M') return (v/1e6).toLocaleString(undefined,{maximumFractionDigits:1}); if(unit==='PCT1') return Number(v).toLocaleString(undefined,{maximumFractionDigits:1}); return Number(v).toLocaleString(); }

// --- UI render from local country JSON ---
function renderHeader(years){
  els.thead.innerHTML='';
  const tr=document.createElement('tr');
  const th0=document.createElement('th'); th0.className='sticky-first'; th0.textContent='Indicator'; tr.appendChild(th0);
  years.forEach(y=>{ const th=document.createElement('th'); th.textContent=y; tr.appendChild(th); });
  els.thead.appendChild(tr);
}

async function renderTable(country){
  clearError(); els.tbody.innerHTML=''; els.copyCsvBtn.disabled=true; els.downloadCsvBtn.disabled=true; setStatus('Loading country JSONâ€¦');
  const data = await getLocalJson(`${country}.json`);
  const years = Array.isArray(data?.years) && data.years.length ? data.years.map(String) : [];
  if(!years.length){ showError(`No years in ${country}.json`); setStatus(''); return; }
  renderHeader(years);

  const series = data?.series || {}; const frag = document.createDocumentFragment();
  for(const group of INDICATOR_GROUPS){
    const trg=document.createElement('tr'); trg.className='group-row';
    const thg=document.createElement('th'); thg.colSpan=years.length+1; thg.textContent=group.title; trg.appendChild(thg); frag.appendChild(trg);
    for(const row of group.rows){
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.className='sticky-first'; th.innerHTML = `${row.name} <span class="badge">${row.code}</span>`; tr.appendChild(th);
      const m = series[row.code] || {}; // object: { "YYYY": value }
      years.forEach(y=>{ const td=document.createElement('td'); const v = (y in m)? Number(m[y]) : null; td.textContent = numberFmt(v, row.unit); tr.appendChild(td); });
      frag.appendChild(tr);
    }
  }
  els.tbody.appendChild(frag);
  setStatus(`Done Â· ${years[0]}â€“${years[years.length-1]}`);
  els.copyCsvBtn.disabled=false; els.downloadCsvBtn.disabled=false;
  els.copyCsvBtn.onclick = ()=> copyCsv(years);
  els.downloadCsvBtn.onclick = ()=> downloadCsv(years);
}

function toCsv(years){
  const rows=[]; rows.push(['Indicator',...years]);
  const trs=Array.from(els.tbody.querySelectorAll('tr'));
  for(const tr of trs){ if(tr.classList.contains('group-row')){ rows.push([tr.textContent.trim()]); continue; }
    const cells=Array.from(tr.children); const name=cells[0].textContent.replace(/\s*DT\.[A-Z0-9_.-]+\s*$/,'').trim(); const vals=cells.slice(1).map(td=>td.textContent.trim()); rows.push([name,...vals]); }
  return rows.map(r=>r.map(c=>(/[",\n]/.test(c)? '"'+c.replaceAll('"','""')+'"': c)).join(',')).join('\n');
}
async function copyCsv(years){ const csv=toCsv(years); await navigator.clipboard.writeText(csv); setStatus('CSV copied'); setTimeout(()=>setStatus(''),1200); }
function downloadCsv(years){ const csv=toCsv(years); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const label=els.select.options[els.select.selectedIndex]?.text?.replace(/\s+\(.+\)$/,'')||'country'; a.href=url; a.download=`IDS_country_table_${label.replace(/\s+/g,'_')}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500); }

// Diagnostics
els.btnPing.addEventListener('click', async ()=>{
  els.diagOut.textContent='';
  try{
    const list = await getLocalJson('countries.json');
    const c = els.select.value || (Array.isArray(list)&&list[0]?.id) || 'AFG';
    await getLocalJson(`${c}.json`);
    els.diagOut.textContent='Local JSON OK: countries.json and '+c+'.json present.';
  }catch(e){ els.diagOut.textContent='Local JSON check failed: '+e.message; }
});

function runTests(){
  const results=[]; const n=(s)=> typeof s==='string'? parseFloat(s.replace(/[^0-9+\-\.]/g,'')): s; const assert=(name,cond,got)=>results.push({name,pass:!!cond,got});
  // existing tests
  assert('numberFmt USD_M', Math.abs(n(numberFmt(123456789,'USD_M'))-123.5)<0.11, numberFmt(123456789,'USD_M'));
  assert('numberFmt PCT1', /12[\.,]3/.test(numberFmt(12.34,'PCT1')), numberFmt(12.34,'PCT1'));
  // new tests for local JSON shape
  const sample = { years:['2019','2020','2021'], series:{ 'DT.DOD.DECT.CD':{ '2019':1000000,'2020':2000000 }}};
  const yrs = sample.years; assert('local years array', Array.isArray(yrs)&&yrs.length===3, yrs.join(','));
  const s = sample.series['DT.DOD.DECT.CD']; assert('series object exists', !!s && typeof s==='object', JSON.stringify(s));

  const pass=results.filter(r=>r.pass).length; const fail=results.length-pass; els.testStatus.textContent=`Tests: ${pass} passed, ${fail} failed`; els.testStatus.className='pill '+(fail?'fail':'pass'); els.diagOut.innerHTML=results.map(r=>`${r.pass?'âœ…':'âŒ'} ${r.name} ${r.pass?'':`â†’ got: ${r.got}`}`).join('\n');
}
els.btnRunTests.addEventListener('click', runTests);

// Init
(async function init(){
  try{
    await loadCountries();
    const c = els.select.value;
    await renderTable(c);
    runTests();
  }catch(e){ showError('Failed to initialize. '+e.message); setStatus(''); }
})();

els.select.addEventListener('change', ()=> renderTable(els.select.value));
</script>
</body>
</html>

